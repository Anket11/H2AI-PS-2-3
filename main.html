<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Details</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 20px; }
    .container { max-width: 600px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; background: #fff; }
    .discharge-detail { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; }
    .checkin { border: 1px dashed #aaa; padding: 8px; margin: 8px 0; }
    .readonly { background: #eee; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Patient Details</h1>
    <div id="patientDetails"></div>
  </div>

  <script>
    // Utility function to get a query parameter by name from the URL
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // Fetch patient details from the API and render them
    async function fetchPatientDetails() {
      const patientId = getQueryParam('id');
      const detailsDiv = document.getElementById("patientDetails");

      if (!patientId) {
        detailsDiv.innerHTML = "<p>No patient ID provided in the URL.</p>";
        return;
      }

      try {
        const res = await fetch(`http://localhost:3000/api/patients/${patientId}`);
        if (!res.ok) {
          throw new Error(`Patient not found (status ${res.status})`);
        }
        const patient = await res.json();
        renderPatientDetails(patient);
      } catch (err) {
        detailsDiv.innerHTML = `<p>Error: ${err.message}</p>`;
      }
    }

    // Render patient details, discharge details, and check-ins
    function renderPatientDetails(patient) {
      let html = `<h2>${patient.name}</h2>
                  <p><strong>Status:</strong> ${patient.status}</p>
                  <p><strong>Admission Reason:</strong> ${patient.admissionReason}</p>`;

      if (patient.dischargeDetails && patient.dischargeDetails.length > 0) {
        patient.dischargeDetails.forEach(detail => {
          html += `<div class="discharge-detail">
                    <h3>Discharge Detail (ID: ${detail.discharge_id})</h3>
                    <p><strong>Date:</strong> ${new Date(detail.dischargeDate).toLocaleString()}</p>
                    <p><strong>Diagnosis:</strong> ${detail.diagnosis}</p>
                    <p><strong>Summary:</strong> ${detail.dischargeSummary}</p>
                    <p><strong>Medications:</strong> ${detail.medications.map(med => `${med.name} - ${med.dosage} (${med.frequency})`).join(", ")}</p>
                    <p><strong>Activity Restrictions:</strong> ${detail.activityRestrictions}</p>
                    <p><strong>Diet Recommendations:</strong> ${detail.dietRecommendations}</p>
                    <p><strong>Red Flag Symptoms:</strong> ${detail.redFlagSymptoms}</p>
                    <p><strong>Next Follow-up:</strong> ${detail.nextFollowupDue}</p>
                    <p><strong>Emergency Contact:</strong> ${detail.contactForEmergency}</p>
                    <p><strong>Instructions:</strong> ${detail.dischargeInstructions}</p>`;

          // Render check-ins if checkInTemplate and checkIns exist
          if (detail.checkIns && detail.checkIns.length > 0 && detail.checkInTemplate && detail.checkInTemplate.questions) {
            html += `<h4>Check-Ins:</h4>`;
            detail.checkIns.forEach((checkIn, index) => {
              html += `<div class="checkin">
                        <p><strong>Date:</strong> ${new Date(checkIn.date).toLocaleString()}</p>
                        <p><strong>Status:</strong> ${checkIn.status}</p>`;
              // Loop over each question in the checkInTemplate
              detail.checkInTemplate.questions.forEach(question => {
                const response = checkIn.response[question] || "";
                if (checkIn.status === "pending") {
                  html += `<label>${question}</label>
                           <input type="text" id="input-${index}-${question}" value="${response}">`;
                } else {
                  html += `<label>${question}</label>
                           <input type="text" value="${response}" class="readonly" disabled>`;
                }
              });
              // If check-in is pending, provide a submit button to update it
              if (checkIn.status === "pending") {
                html += `<button onclick="updateCheckIn('${detail.discharge_id}', ${index})">Submit Update</button>`;
              }
              html += `</div>`;
            });
          }
          html += `</div>`;
        });
      } else {
        html += `<p>No discharge details available.</p>`;
      }

      document.getElementById("patientDetails").innerHTML = html;
    }

    // Update a pending check-in: collect input values and send a PUT request to update it
    async function updateCheckIn(dischargeId, checkInIndex) {
      const patientId = getQueryParam('id');
      // Use the checkInTemplate questions (here we assume they are constant as provided by the API)
      const questions = ["Medication taken?", "Symptoms", "How are you feeling?"];
      let response = {};
      questions.forEach(question => {
        const input = document.getElementById(`input-${checkInIndex}-${question}`);
        if (input) {
          response[question] = input.value;
        }
      });

      try {
        const res = await fetch(`http://localhost:3000/api/patients/${patientId}/discharge/${dischargeId}/checkin/${checkInIndex}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ response })
        });
        if (!res.ok) {
          throw new Error(`Update failed (status ${res.status})`);
        }
        // Re-fetch and re-render patient details after the update
        fetchPatientDetails();
      } catch (error) {
        alert("Error updating check-in: " + error.message);
      }
    }

    // Load patient details when the page loads
    window.onload = fetchPatientDetails;
  </script>
</body>
</html>
