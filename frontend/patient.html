<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Patient Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f8f9fa;
    }

    .container {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      max-width: 800px;
      margin: 0 auto;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .header h2 {
      margin: 0;
    }

    .btn {
      display: inline-block;
      margin-top: 10px;
      background: #007bff;
      color: #fff;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
    }

    .btn:hover {
      background: #0056b3;
    }

    .green {
      background: #28a745;
      color: #fff;
    }

    .green:hover {
      background: #218838;
    }

    .reset-btn {
      background: #dc3545;
      color: #fff;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
      text-decoration: none;
    }

    .reset-btn:hover {
      background: #c82333;
    }

    .back-btn {
      background: #6c757d;
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      text-decoration: none;
      margin-top: 10px;
      display: inline-block;
    }

    .back-btn:hover {
      background: #5a6268;
    }

    .section {
      margin-bottom: 20px;
    }

    .discharge-form,
    .custom-checkin-form,
    .display-section {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .discharge-form label,
    .custom-checkin-form label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }

    .discharge-form input[type="text"],
    .discharge-form input[type="datetime-local"],
    .discharge-form textarea,
    .discharge-form input[type="number"],
    .custom-checkin-form input[type="text"],
    .custom-checkin-form input[type="number"] {
      width: 100%;
      padding: 6px;
      margin-bottom: 10px;
    }

    .medications-container {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .medications-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .medication-row {
      display: flex;
      gap: 10px;
      margin-bottom: 6px;
    }

    .medication-row input {
      flex: 1;
      padding: 4px;
    }

    /* Template Section for Standard Check-In Questions */
    .template-section,
    .instances-section {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .template-section h5,
    .instances-section h5 {
      margin: 0 0 10px 0;
    }

    .template-row,
    .instances-row {
      margin-bottom: 6px;
    }

    .template-row input,
    .instances-row input {
      width: 100%;
      padding: 4px;
      margin-bottom: 5px;
    }

    .responses {
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }

    .response-item {
      border-bottom: 1px solid #eee;
      padding: 8px 0;
    }

    .response-item:last-child {
      border-bottom: none;
    }

    .call-btn {
      background: #ffc107;
      color: #000;
      padding: 6px 10px;
      border-radius: 4px;
      text-decoration: none;
      cursor: pointer;
    }

    .call-btn:hover {
      background: #e0a800;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header: Patient Name, Call Button, Back to Dashboard, and Reset Data -->
    <div class="header">
      <h2 id="patientName">Managing Patient: [Patient Name]</h2>
      <div>
        <button class="btn" id="callBtn">Call Patient</button>
        <a href="index.html" class="back-btn">Back to Dashboard</a>
      </div>
    </div>

    <!-- Basic Patient Info (without discharge details) -->
    <div id="patientInfo" class="section"></div>

    <!-- Action Section: Only if patient is not discharged -->
    <div id="actionSection" class="section">
      <button id="dischargePatientBtn" class="btn green">Discharge Patient</button>
    </div>

    <!-- Combined Discharge Form Section (hidden until "Discharge Patient" is clicked) -->
    <div id="dischargeFormSection" class="section" style="display: none;">
      <div class="discharge-form">
        <h3>Discharge Details & Check-In Form</h3>

        <!-- Discharge Details -->
        <label for="dischargeDate">Discharge Date/Time</label>
        <input type="datetime-local" id="dischargeDate">

        <label for="diagnosis">Diagnosis</label>
        <input type="text" id="diagnosis" placeholder="e.g., J15.9 (Pneumonia)">

        <label for="dischargeSummary">Discharge Summary</label>
        <textarea id="dischargeSummary" rows="2" placeholder="Overall hospitalization summary"></textarea>

        <!-- Dynamic Medication List -->
        <div class="medications-container">
          <div class="medications-header">
            <span>Medications</span>
            <button id="addMedicationBtn" class="btn" style="padding: 4px 8px; font-size: 0.9em;">Add
              Medication</button>
          </div>
          <div id="medicationsList"></div>
        </div>

        <label for="activityRestrictions">Activity Restrictions</label>
        <input type="text" id="activityRestrictions" placeholder="No heavy lifting, etc.">

        <label for="dietRecommendations">Diet Recommendations</label>
        <input type="text" id="dietRecommendations" placeholder="Light, balanced diet...">

        <label for="redFlagSymptoms">Red-Flag Symptoms</label>
        <input type="text" id="redFlagSymptoms" placeholder="Fever above 101°F...">

        <label for="nextFollowupDue">Next Follow-up Due</label>
        <input type="text" id="nextFollowupDue" placeholder="Check‑up in 7 days...">

        <label for="contactForEmergency">Contact For Emergency</label>
        <input type="text" id="contactForEmergency" placeholder="(555) 123‑4567 or go to ER">

        <label for="dischargeInstructions">Discharge Instructions</label>
        <textarea id="dischargeInstructions" rows="2" placeholder="Keep incision clean..."></textarea>

        <!-- Check-In Form Customization -->
        <div class="custom-checkin-form">
          <h4>Customize Check-In Form for Patient</h4>
          <!-- Standard Check-In Template (read-only) -->
          <div class="template-section" id="templateContainer">
            <h5>Standard Check-In Questions (Patient will answer these):</h5>
            <div class="template-row">
              <input type="text" class="template-question" value="Medication taken?" readonly>
            </div>
            <div class="template-row">
              <input type="text" class="template-question" value="Symptoms" readonly>
            </div>
            <div class="template-row">
              <input type="text" class="template-question" value="How are you feeling?" readonly>
            </div>
          </div>
          <!-- Option to add extra questions -->
          <div>
            <button id="addNewQuestionBtn" class="btn">Add New Question</button>
          </div>

          <!-- Expected Number of Check-Ins -->
          <label for="numCheckins">Expected Number of Check-Ins</label>
          <input type="number" id="numCheckins" min="1" placeholder="e.g., 3">
          <button id="setCheckinCountBtn" class="btn">Set Count</button>

          <!-- Check-In Instances: Only Check In Date input (date only) for each instance -->
          <div class="instances-section" id="checkinInstancesContainer">
            <h5>Check-In Instances (Nurse sets the date):</h5>
            <!-- Rows will be generated here -->
          </div>
        </div>

        <!-- Confirm Discharge Button -->
        <button id="confirmDischargeBtn" class="btn green">Confirm Discharge</button>
      </div>
    </div>

    <!-- Display Section: Once discharged, show summary (only once) -->
    <div id="displaySection" class="section" style="display: none;"></div>

    <!-- Check-In Responses Section: List all check-ins (only show responses if filled; otherwise, show date and pending/missed) -->
    <div id="checkInsSection" class="section">
      <h3>Patient Check-In Responses</h3>
      <div id="responsesList" class="responses"></div>
    </div>
  </div>

  <script>
    // --- GLOBAL SETUP ---
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("patientId");
    // Base API URL - adjust as needed
    const API_BASE = 'http://localhost:5000/api/patients';

    // Fetch patient data from the backend API
    function fetchPatientData() {
      return fetch(`${API_BASE}/${patientId}`)
        .then(res => res.json())
        .then(data => {
          currentPatient = data;
          renderHeader();
          renderPatientInfo();
          renderCheckIns();
          if (currentPatient.status === "Discharged") {
            actionSection.style.display = "none";
            dischargeFormSection.style.display = "none";
            displaySection.style.display = "block";
            displaySection.innerHTML = generateDisplayHTML();
          }
        })
        .catch(err => console.error("Error fetching patient data:", err));
    }

    let currentPatient;

    // --- DOM ELEMENTS ---
    const patientNameEl = document.getElementById("patientName");
    const callBtn = document.getElementById("callBtn");
    const patientInfoEl = document.getElementById("patientInfo");
    const actionSection = document.getElementById("actionSection");
    const dischargePatientBtn = document.getElementById("dischargePatientBtn");
    const dischargeFormSection = document.getElementById("dischargeFormSection");
    const dischargeDateInput = document.getElementById("dischargeDate");
    const diagnosisInput = document.getElementById("diagnosis");
    const dischargeSummaryInput = document.getElementById("dischargeSummary");
    const medicationsListEl = document.getElementById("medicationsList");
    const addMedicationBtn = document.getElementById("addMedicationBtn");
    const activityRestrictionsInput = document.getElementById("activityRestrictions");
    const dietRecommendationsInput = document.getElementById("dietRecommendations");
    const redFlagSymptomsInput = document.getElementById("redFlagSymptoms");
    const nextFollowupDueInput = document.getElementById("nextFollowupDue");
    const contactForEmergencyInput = document.getElementById("contactForEmergency");
    const dischargeInstructionsInput = document.getElementById("dischargeInstructions");

    // Check-In Form Customization DOM
    const templateContainer = document.getElementById("templateContainer");
    const addNewQuestionBtn = document.getElementById("addNewQuestionBtn");
    const numCheckinsInput = document.getElementById("numCheckins");
    const setCheckinCountBtn = document.getElementById("setCheckinCountBtn");
    const checkinInstancesContainer = document.getElementById("checkinInstancesContainer");

    const confirmDischargeBtn = document.getElementById("confirmDischargeBtn");
    const displaySection = document.getElementById("displaySection");
    const responsesListEl = document.getElementById("responsesList");
    const resetBtn = document.getElementById("resetBtn");

    
    // --- Helper Functions ---
    function renderHeader() {
      if (!currentPatient) return;
      patientNameEl.textContent = "Managing Patient: " + currentPatient.name;
    }
    callBtn.addEventListener("click", () => {
      console.log("Calling " + currentPatient.name + "...");
    });

    function renderPatientInfo() {
      if (!currentPatient) {
        patientInfoEl.innerHTML = "<p>Patient not found.</p>";
        return;
      }
      let html = `<p><strong>Status:</strong> ${currentPatient.status}</p>
                  <p><strong>Admission Reason:</strong> ${currentPatient.admissionReason}</p>`;
      patientInfoEl.innerHTML = html;
    }

    // --- Action Section ---
    dischargePatientBtn.addEventListener("click", () => {
      dischargeFormSection.style.display = "block";
      actionSection.style.display = "none";
    });

    // --- Medications: Dynamic List ---
    function addMedicationRow(med = { name: "", dosage: "", frequency: "" }) {
      const row = document.createElement("div");
      row.className = "medication-row";
      row.innerHTML = `
        <input type="text" placeholder="Name" class="med-name" value="${med.name}">
        <input type="text" placeholder="Dosage" class="med-dosage" value="${med.dosage}">
        <input type="text" placeholder="Frequency" class="med-frequency" value="${med.frequency}">
        <button class="btn remove-med-btn" style="background:#dc3545; padding:4px 8px;">X</button>
      `;
      row.querySelector(".remove-med-btn").addEventListener("click", () => {
        medicationsListEl.removeChild(row);
      });
      medicationsListEl.appendChild(row);
    }
    addMedicationBtn.addEventListener("click", () => {
      addMedicationRow();
    });

    // --- Standard Check-In Template ---
    // The template section is pre-populated in HTML with standard questions (read-only).
    // Allow nurse to add extra questions.
    addNewQuestionBtn.addEventListener("click", () => {
      const row = document.createElement("div");
      row.className = "template-row";
      row.innerHTML = `<input type="text" class="template-question" placeholder="Enter new question">`;
      templateContainer.appendChild(row);
    });

    // --- Check-In Instances ---
    // When nurse clicks "Set Count", generate that many check-in instance rows with a date input (date only).
    setCheckinCountBtn.addEventListener("click", () => {
      const count = parseInt(numCheckinsInput.value);
      if (isNaN(count) || count < 1) {
        console.log("Please enter a valid number (minimum 1).");
        return;
      }
      numCheckinsInput.dataset.expectedCount = count;
      checkinInstancesContainer.innerHTML = "";
      for (let i = 0; i < count; i++) {
        const row = document.createElement("div");
        row.className = "instances-row";
        row.innerHTML = `<label>Check In Date for Check-In ${i + 1}</label>
                         <input type="date" class="checkin-date-instance">`;
        checkinInstancesContainer.appendChild(row);
      }
    });

    // --- Discharge Process ---
    confirmDischargeBtn.addEventListener("click", () => {
      const expectedCount = parseInt(numCheckinsInput.dataset.expectedCount || "0");

      // Gather the check-in template questions from the template container.
      const templateQuestions = Array.from(document.querySelectorAll(".template-question"))
        .map(input => input.value.trim())
        .filter(q => q !== "");

      if (templateQuestions.length === 0) {
        console.log("Standard check-in template must have at least one question.");
        return;
      }

      // Gather check-in instance dates from the instance rows.
      const instanceRows = document.querySelectorAll(".checkin-date-instance");
      let instanceDates = [];
      instanceRows.forEach(row => {
        instanceDates.push(row.value);  // Only date, no time.
      });

      const fullCheckinTemplate = {
        questions: templateQuestions
      };

      const dischargeObj = {
        dischargeDate: dischargeDateInput.value,
        diagnosis: diagnosisInput.value,
        dischargeSummary: dischargeSummaryInput.value,
        medications: Array.from(document.querySelectorAll(".medication-row")).map(row => ({
          name: row.querySelector(".med-name").value,
          dosage: row.querySelector(".med-dosage").value,
          frequency: row.querySelector(".med-frequency").value
        })),
        activityRestrictions: activityRestrictionsInput.value,
        dietRecommendations: dietRecommendationsInput.value,
        redFlagSymptoms: redFlagSymptomsInput.value,
        nextFollowupDue: nextFollowupDueInput.value,
        contactForEmergency: contactForEmergencyInput.value,
        dischargeInstructions: dischargeInstructionsInput.value,
        checkInTemplate: fullCheckinTemplate,
        checkInInstances: instanceDates,
        expectedCheckIns: expectedCount
      };

      currentPatient.status = "Discharged";
      currentPatient.dischargeDetails = dischargeObj;

      // Create dummy check-in responses (one for each expected check-in).
      // For each dummy response, the nurse-provided "Check In Date" is stored.
      // Additionally, if the check in date is in the past relative to today's date, mark it as "missed".
      const today = new Date().toISOString().slice(0, 10);
      currentPatient.checkIns = [];
      for (let i = 0; i < expectedCount; i++) {
        const dummy = {};
        templateQuestions.forEach(q => {
          dummy[q] = ""; // Initially empty.
        });
        let status = "pending";
        if (instanceDates[i] && instanceDates[i] < today) {
          status = "missed";
        }
        currentPatient.checkIns.push({
          date: instanceDates[i] || "",
          response: dummy,
          status: status
        });
      }
      updatePatient();

    });
    function updatePatient() {
      // Update the patient via PUT API call
      fetch(`${API_BASE}/${patientId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(currentPatient)
      })
        .then(res => res.json())
        .then(data => {
          currentPatient = data;
          console.log("Patient updated:", data);
          dischargeFormSection.style.display = "none";
          actionSection.style.display = "none";
          displaySection.style.display = "block";
          displaySection.innerHTML = generateDisplayHTML();
          renderPatientInfo();
          renderCheckIns();
        })
        .catch(err => console.error("Error updating patient:", err));
    }

    // --- Generate Display HTML for Summary ---
    function generateDisplayHTML() {
      if (!currentPatient || currentPatient.status !== "Discharged" || !currentPatient.dischargeDetails) return "";
      const dd = currentPatient.dischargeDetails;
      let html = `<h3>Discharge Details</h3>
        <p><strong>Discharge Date:</strong> ${dd.dischargeDate}</p>
        <p><strong>Diagnosis:</strong> ${dd.diagnosis}</p>
        <p><strong>Summary:</strong> ${dd.dischargeSummary}</p>
        <p><strong>Medications:</strong></p>
        <ul>${dd.medications && dd.medications.length ? dd.medications.map(m => `<li>${m.name} - ${m.dosage} - ${m.frequency}</li>`).join('') : "<li>N/A</li>"}</ul>
        <p><strong>Activity Restrictions:</strong> ${dd.activityRestrictions}</p>
        <p><strong>Diet Recommendations:</strong> ${dd.dietRecommendations}</p>
        <p><strong>Red-Flag Symptoms:</strong> ${dd.redFlagSymptoms}</p>
        <p><strong>Next Follow-up Due:</strong> ${dd.nextFollowupDue}</p>
        <p><strong>Emergency Contact:</strong> ${dd.contactForEmergency}</p>
        <p><strong>Discharge Instructions:</strong> ${dd.dischargeInstructions}</p>
        <h3>Check-In Form Template</h3>
        <ul>${dd.checkInTemplate.questions.map(q => `<li>${q}</li>`).join('')}</ul>
        <p><strong>Expected Check-Ins:</strong> ${dd.expectedCheckIns}</p>`;
      return html;
    }

    function renderCheckIns() {
  responsesListEl.innerHTML = "";
  if (!currentPatient || currentPatient.status !== "Discharged") {
    responsesListEl.innerHTML = "<p>No check‑ins available.</p>";
    return;
  }

  currentPatient.checkIns.forEach((ci, index) => {
    let hasAnswer = false;
    const template = currentPatient.dischargeDetails.checkInTemplate;
    let responsesHtml = "";
    
    if (template && template.questions.length > 0) {
      template.questions.forEach(q => {
        const answer = ci.response[q] ? ci.response[q].trim() : "";
        if (answer !== "") {
          hasAnswer = true;
        }
        responsesHtml += `<p><strong>${q}</strong>: ${answer}</p>`;
      });
    }

    // Determine check-in status
    const today = new Date().toISOString().slice(0, 10);
    let status = "Pending";
    
    if (!hasAnswer) {
      if (ci.date && ci.date < today) {
        status = "Missed";
      }
    } else {
      status = "Completed";
    }

    // Construct the check-in display
    const div = document.createElement("div");
    div.className = "response-item";
    div.innerHTML = `<p><strong>Check-In ${index + 1}:</strong></p>
                     <p><strong>${ci.date || "No Date"}</strong> - ${status}</p>`;

    // Only show responses if status is "Completed"
    if (status === "Completed") {
      div.innerHTML += responsesHtml;
    }

    responsesListEl.appendChild(div);
  });
}

    // --- INIT ---
    function init() {
      if (!currentPatient) {
        console.log("Patient not found.");
        return;
      }
      renderHeader();
      renderPatientInfo();
      renderCheckIns();
      if (currentPatient.status === "Discharged") {
        actionSection.style.display = "none";
        dischargeFormSection.style.display = "none";
        displaySection.style.display = "block";
        displaySection.innerHTML = generateDisplayHTML();
      }
    }

    // Fetch data from the backend and initialize.
    function fetchPatientData() {
      fetch(`${API_BASE}/${patientId}`)
        .then(res => res.json())
        .then(data => {
          currentPatient = data;
          init();
        })
        .catch(err => console.error("Error fetching patient data:", err));
    }
    fetchPatientData();
  </script>
</body>

</html>